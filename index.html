<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="sh-health-directory helps you find every address in Sh. Funadhoo with pinpoint accuracy.">

  <!-- PWA Meta -->
  <link rel="manifest" href="https://ahmedsharyph.github.io/sh-health-directory/manifest.json">
  <meta name="theme-color" content="#00bcd4">
  <link rel="apple-touch-icon" href="https://ahmedsharyph.github.io/sh-health-directory/ft_logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="sh-health-directory">

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-screen m-0 p-0 font-sans">

<nav class="fixed top-0 left-0 right-0 bg-white shadow z-50">
  <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">

    <!-- Logo + Title -->
    <a href="index.html" class="flex items-center gap-2">
      <img src="./logo.png" alt="Logo" class="w-8 h-8">
      <span class="hidden lg:inline font-semibold text-emerald-900">Shaviyani Health Directory</span>
    </a>

    <!-- Search Form (hidden on small screens) -->
    <form id="searchForm" class="hidden md:flex flex-grow mx-4" role="search" onsubmit="return false;">
      <input
        id="searchInput"
        type="search"
        placeholder="🔍 Search by any field..."
        autocomplete="off"
        aria-label="Search directory"
        class="w-full border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600"
      />
    </form>

    <!-- Hamburger (mobile) -->
    <button id="hamburgerBtn" class="text-2xl lg:hidden" aria-label="Toggle navigation" aria-expanded="false">
      &#9776;
    </button>

    <!-- Navigation Links -->
    <div id="navbarNav" class="hidden lg:flex lg:items-center lg:space-x-4">
      <a href="add-contact.html" class="block px-4 py-2 text-sm font-medium hover:text-emerald-700">Add Contact</a>
    </div>

  </div>
</nav>

<script>
  // Hamburger toggle
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const navbarNav = document.getElementById('navbarNav');

  hamburgerBtn.addEventListener('click', () => {
    const expanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
    hamburgerBtn.setAttribute('aria-expanded', !expanded);
    navbarNav.classList.toggle('hidden');
  });
</script>


<script>
  // Hamburger toggle
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const navbarNav = document.getElementById('navbarNav');

  hamburgerBtn.addEventListener('click', () => {
    const expanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
    hamburgerBtn.setAttribute('aria-expanded', !expanded);
    navbarNav.classList.toggle('hidden');
  });
</script>


  <!-- Main Content -->
  <main class="max-w-7xl mx-auto mt-4 px-4" id="directoryContainer">
    <p class="no-results">Loading data…</p>
  </main>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwndImcPMsQCTx1xLtxolE7Q7nOdN_nVpmOh7fw0U0Sy0-0u30Chp6ovUVhJgk2XdRuNg/exec';

    function normalize(str) {
      return (str || '').toString().toLowerCase().replace(/\s+/g, ' ').trim();
    }

    let allRows = [];

    async function loadData() {
      const container = document.getElementById('directoryContainer');
      try {
        const res = await fetch(WEB_APP_URL);
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);

        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p class="no-results">No data found.</p>';
          return;
        }

        container.innerHTML = '';

        const grouped = {};
        data.forEach(item => {
          const center = String(item['Health Center'] || 'Unknown').trim();
          if (!grouped[center]) grouped[center] = [];
          grouped[center].push(item);
        });

        for (const center in grouped) {
          const section = document.createElement('section');
          section.className = 'center-group';
          section.dataset.center = center.toLowerCase();

          const rowsHtml = grouped[center].map(person => {
            const fullName = String(person['Assigned To'] || '').trim();
            const role = String(person['Role  or Function'] || '').trim();
            const dept = String(person['Department'] || '').trim();
            const phoneRaw = person['Contact Number'] || '';
            const phone = String(phoneRaw).trim();
            const searchText = normalize(`${center} ${fullName} ${role} ${dept} ${phone}`);

            return `
              <tr class="data-row" data-search="${searchText}">
                <td class="px-4 py-2"><a href="tel:${phone}" class="text-emerald-600">📞 ${phone}</a></td>
                <td class="px-4 py-2">${dept}</td>
                <td class="px-4 py-2">${fullName}</td>
                <td class="px-4 py-2">${role}</td>
              </tr>`;
          }).join('');

          section.innerHTML = `
            <h2>${center}</h2>
            <div class="overflow-x-auto bg-white rounded shadow mb-6">
              <table class="min-w-full border-collapse sortable-table">
                <thead class="bg-emerald-600 text-white">
                  <tr>
                    <th class="px-4 py-2" data-col="0">Phone <span class="sort-arrow"></span></th>
                    <th class="px-4 py-2" data-col="1">Department <span class="sort-arrow"></span></th>
                    <th class="px-4 py-2" data-col="2">Assignee <span class="sort-arrow"></span></th>
                    <th class="px-4 py-2" data-col="3">Role <span class="sort-arrow"></span></th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;

          container.appendChild(section);
        }

        allRows = Array.from(document.querySelectorAll('.data-row'));
        enableSorting();

      } catch (error) {
        container.innerHTML = `<p class="no-results">Failed to load data: ${error.message}</p>`;
        console.error(error);
      }
    }

    function filterData() {
      const term = normalize(document.getElementById('searchInput').value);
      if (!term) {
        allRows.forEach(row => (row.style.display = ''));
        document.querySelectorAll('section.center-group').forEach(s => (s.style.display = ''));
        const msg = document.querySelector('.no-results-message');
        if (msg) msg.remove();
        return;
      }

      let anyVisible = false;

      allRows.forEach(row => {
        const match = row.dataset.search.includes(term);
        row.style.display = match ? '' : 'none';
        if (match) anyVisible = true;
      });

      document.querySelectorAll('section.center-group').forEach(section => {
        const visibleRows = section.querySelectorAll('tbody tr:not([style*="display: none"])');
        section.style.display = visibleRows.length ? '' : 'none';
      });

      const container = document.getElementById('directoryContainer');
      if (!anyVisible && !document.querySelector('.no-results-message')) {
        const msg = document.createElement('p');
        msg.className = 'no-results no-results-message';
        msg.textContent = 'No matching contacts found.';
        container.appendChild(msg);
      } else if (anyVisible) {
        const msg = document.querySelector('.no-results-message');
        if (msg) msg.remove();
      }
    }

    function enableSorting() {
      const tables = document.querySelectorAll('table.sortable-table');
      tables.forEach(table => {
        const headers = table.querySelectorAll('thead th');
        headers.forEach(th => {
          th.addEventListener('click', () => {
            const colIndex = parseInt(th.getAttribute('data-col'));
            const tbody = table.querySelector('tbody');
            const rowsArray = Array.from(tbody.querySelectorAll('tr'));

            let currentSort = th.getAttribute('data-sort') || 'none';
            headers.forEach(h => {
              if (h !== th) {
                h.setAttribute('data-sort', 'none');
                h.querySelector('.sort-arrow').textContent = '';
              }
            });

            let newSort = (currentSort === 'none' || currentSort === 'desc') ? 'asc' : 'desc';
            th.setAttribute('data-sort', newSort);
            th.querySelector('.sort-arrow').textContent = newSort === 'asc' ? '▲' : '▼';

            rowsArray.sort((a, b) => {
              let aText = a.children[colIndex].textContent.trim().toLowerCase();
              let bText = b.children[colIndex].textContent.trim().toLowerCase();
              if (colIndex === 0) {
                aText = aText.replace(/\D/g, '') || '0';
                bText = bText.replace(/\D/g, '') || '0';
                return newSort === 'asc' ? aText.localeCompare(bText, undefined, {numeric:true}) : bText.localeCompare(aText, undefined, {numeric:true});
              }
              if (aText < bText) return newSort === 'asc' ? -1 : 1;
              if (aText > bText) return newSort === 'asc' ? 1 : -1;
              return 0;
            });

            rowsArray.forEach(row => tbody.appendChild(row));
          });
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('searchInput').addEventListener('input', filterData);
    });

    window.onload = loadData;
  </script>

  <script src="https://ahmedsharyph.github.io/sh-health-directory/install.js" defer></script>
</body>
</html>
