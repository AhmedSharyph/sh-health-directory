<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="sh-health-directory helps you find every address in Sh. Funadhoo with pinpoint accuracy.">

  <!-- PWA Meta -->
  <link rel="manifest" href="https://ahmedsharyph.github.io/sh-health-directory/manifest.json">
  <meta name="theme-color" content="#00bcd4">
  <link rel="apple-touch-icon" href="https://ahmedsharyph.github.io/sh-health-directory/ft_logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="sh-health-directory">

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="m-0 p-0 h-full font-sans antialiased">

  <!-- App Header -->
  <div class="flex flex-wrap items-center justify-center p-4 bg-white shadow">
    <img src="https://ahmedsharyph.github.io/sh-health-directory/ft_logo.png" alt="Logo" class="w-12 h-12 mr-4">
    <div class="text-center">
      <div class="text-2xl font-bold text-teal-700">sh-health-directory</div>
      <div class="text-gray-600 text-sm">Funadhoo Location Finder</div>
    </div>
  </div>

  <!-- Dropdown -->
  <div class="sticky top-0 z-50 bg-white p-2 flex justify-center shadow">
    <input id="dropdown" list="houses-list" placeholder="Search..." autocomplete="off"
      class="w-full max-w-md px-4 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-teal-500"/>
    <button id="clear-dropdown" title="Clear"
      class="ml-2 px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">âŒ</button>
    <datalist id="houses-list"></datalist>
  </div>

  <!-- Loader -->
  <div id="loader" class="text-center text-gray-500 p-3 text-base">Loading map data...</div>

  <!-- Map -->
  <div id="map" class="w-full h-[85vh]"></div>

  <!-- Floating Buttons -->
  <div id="floating-button-container" class="absolute flex flex-col gap-2 items-end pointer-events-auto right-2"
       style="top:10px; width:220px;">
    <button id="directions-btn" class="map-button hidden bg-orange-500 text-white font-bold py-2 px-4 rounded shadow text-left">ğŸ¤¾ Get Directions</button>
    <button id="googlemaps-btn" class="map-button hidden bg-blue-600 text-white font-bold py-2 px-4 rounded shadow text-left">ğŸ—ºï¸ Open in Maps</button>
    <button id="share-btn" class="map-button hidden bg-green-500 text-white font-bold py-2 px-4 rounded shadow text-left">ğŸ“¤ Share Location</button>
    <button id="reset-btn" class="map-button bg-red-500 text-white font-bold py-2 px-4 rounded shadow text-center hidden">ğŸ”„ Reset View</button>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz8_X-uaxok6xQK0mog2hIvYVN_D3ydOPGOHdXC8SZ8tHulyVo2xm76NSTHCWaQ_8KzIg/exec?type=address";
    const defaultCenter = { lat: 6.1535, lng: 73.28975 };
    const defaultZoom = 15;
    const funadhooBounds = { north: 6.1700, south: 6.1370, east: 73.2953, west: 73.2842 };
    let map, marker, userMarker, houseData = [], currentHouse = null, userLocation = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultCenter,
        zoom: defaultZoom,
        gestureHandling: 'greedy',
        mapTypeId: google.maps.MapTypeId.SATELLITE,
      });

      map.addListener("idle", () => {
        document.getElementById("reset-btn").classList.toggle("hidden", isMapAtDefaultView());
      });

      document.getElementById("dropdown").addEventListener("change", e => zoomToHouse(e.target.value.trim()));
      document.getElementById("clear-dropdown").addEventListener("click", resetView);
      document.getElementById("reset-btn").addEventListener("click", resetView);

      document.getElementById("googlemaps-btn").addEventListener("click", () => {
        if (!currentHouse) return;
        const lat = currentHouse.lat;
        const lng = currentHouse.lng;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        if (isIOS) {
          const useApple = confirm("Open in Apple Maps?\nCancel = Google Maps");
          if (useApple) {
            window.location.href = `maps://?q=${lat},${lng}`;
          } else {
            window.open(`https://www.google.com/maps?q=${lat},${lng}&z=18&t=k`, '_blank');
          }
        } else {
          window.open(`https://www.google.com/maps?q=${lat},${lng}&z=18&t=k`, '_blank');
        }
      });

      document.getElementById("directions-btn").addEventListener("click", () => {
        if (!currentHouse || !userLocation) return alert("Select a house and allow location access.");
        const url = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${currentHouse.lat},${currentHouse.lng}&travelmode=walking`;
        window.open(url, '_blank');
      });

      document.getElementById("share-btn").addEventListener("click", () => {
        if (!currentHouse) return;
        const link = `https://maps.google.com/?q=${currentHouse.lat},${currentHouse.lng}`;
        const text = `Location of ${currentHouse.name}: ${link}`;
        if (navigator.share) {
          navigator.share({ title: currentHouse.name, text, url: link }).catch(console.error);
        } else {
          navigator.clipboard.writeText(text)
            .then(() => alert("Copied to clipboard:\n\n" + text))
            .catch(() => prompt("Copy this:", text));
        }
      });

      loadHouses();
      requestUserLocation();
    }

    function isMapAtDefaultView() {
      const center = map.getCenter();
      return Math.abs(center.lat() - defaultCenter.lat) < 0.0001 &&
             Math.abs(center.lng() - defaultCenter.lng) < 0.0001 &&
             map.getZoom() === defaultZoom;
    }

    function resetView() {
      if (marker) marker.setMap(null);
      if (userMarker) userMarker.setMap(null);
      currentHouse = null;
      document.getElementById("dropdown").value = '';
      ["directions-btn", "googlemaps-btn", "share-btn", "reset-btn"].forEach(id =>
        document.getElementById(id).classList.add("hidden")
      );
      map.setCenter(defaultCenter);
      map.setZoom(defaultZoom);
    }

    async function loadHouses() {
      try {
        const res = await fetch(GAS_URL);
        houseData = await res.json();
        document.getElementById("loader").classList.add("hidden");
        const datalist = document.getElementById("houses-list");
        datalist.innerHTML = '';
        houseData.forEach(h => {
          if (h.name && !isNaN(h.lat) && !isNaN(h.lng)) {
            const option = document.createElement("option");
            option.value = h.name;
            datalist.appendChild(option);
          }
        });
      } catch (e) {
        alert("Failed to load house data.");
        console.error(e);
      }
    }

    function zoomToHouse(name) {
      if (marker) marker.setMap(null);
      const house = houseData.find(h => h.name?.toLowerCase() === name.toLowerCase());
      if (!house || isNaN(house.lat) || isNaN(house.lng)) return alert("Invalid or unknown house.");
      marker = new google.maps.Marker({ position: { lat: Number(house.lat), lng: Number(house.lng) }, map, title: house.name });
      map.setCenter(marker.getPosition());
      map.setZoom(18);
      currentHouse = house;
      ["directions-btn", "googlemaps-btn", "share-btn"].forEach(id =>
        document.getElementById(id).classList.remove("hidden")
      );
    }

    function requestUserLocation() {
      if (!navigator.geolocation) return alert("Geolocation not supported.");
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          const inside = userLocation.lat >= funadhooBounds.south && userLocation.lat <= funadhooBounds.north &&
                         userLocation.lng >= funadhooBounds.west && userLocation.lng <= funadhooBounds.east;
          if (inside) {
            userMarker = new google.maps.Marker({
              position: userLocation,
              map,
              title: "You are here",
              icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });
          } else {
            alert("Your location appears outside Funadhoo.");
          }
        },
        err => console.warn("Location error:", err),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&callback=initMap">
  </script>
  <script src="https://ahmedsharyph.github.io/sh-health-directory/install.js" defer></script>
</body>
</html>
